# Ring ä¸­é—´ä»¶ + Portal å¯è§†åŒ–

è¿™ä¸ª notebook æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Portal æ¥å¯è§†åŒ– Ring ä¸­é—´ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

- âœ… **å®æ—¶è¿½è¸ª**: ä½¿ç”¨ `tap>` å®æ—¶å‘é€ä¸­é—´ä»¶å¤„ç†çš„æ•°æ®åˆ° Portal
- âœ… **å·®å¼‚å¯¹æ¯”**: ä½¿ç”¨ `portal.viewer/diff` ç›´è§‚å±•ç¤ºå¤„ç†å‰åçš„å˜åŒ–
- âœ… **æµç¨‹å¯è§†åŒ–**: è¿½è¸ªè¯·æ±‚åœ¨ä¸­é—´ä»¶é“¾ä¸­çš„å®Œæ•´æµç¨‹
- âœ… **äº¤äº’æ¢æŸ¥**: åˆ©ç”¨ Portal çš„äº¤äº’åŠŸèƒ½æ·±å…¥æ¢æŸ¥æ•°æ®ç»“æ„

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ Clerk

```bash
clj -M:clerk
```

æˆ–åœ¨ REPL ä¸­ï¼š

```clojure
(require '[nextjournal.clerk :as clerk])
(clerk/serve! {:browse? true :port 7777})
```

### 2. æ‰“å¼€ Notebook

åœ¨æµè§ˆå™¨ä¸­è®¿é—® Clerkï¼Œç„¶ååŠ è½½ï¼š

```clojure
(clerk/show! "notebooks/web_dev/ring_middleware_with_portal.clj")
```

### 3. æŸ¥çœ‹ Portal

Notebook ä¼šè‡ªåŠ¨æ‰“å¼€ Portal çª—å£ã€‚å¦‚æœæ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ï¼Œå¯ä»¥è¿è¡Œï¼š

```clojure
(ensure-portal!)
```

## ğŸ“– å¦‚ä½•ä½¿ç”¨

### æŸ¥çœ‹ä¸­é—´ä»¶å¤„ç†æµç¨‹

1. **è¿è¡Œæµ‹è¯•ç¤ºä¾‹**: Notebook ä¸­åŒ…å«å¤šä¸ªæµ‹è¯•ç¤ºä¾‹ï¼Œç›´æ¥è¯„ä¼°å®ƒä»¬å³å¯
2. **è§‚å¯Ÿ Portal**: æ¯ä¸ªä¸­é—´ä»¶çš„å¤„ç†å‰åæ•°æ®ä¼šè‡ªåŠ¨å‘é€åˆ° Portal
3. **ä½¿ç”¨ Diff åŠŸèƒ½**:
   - åœ¨ Portal ä¸­é€‰æ‹©ä»»æ„ `:before` å’Œ `:after` æ•°æ®
   - æŒ‰ `Cmd+D` (Mac) æˆ– `Ctrl+D` (Windows/Linux)
   - Portal ä¼šé«˜äº®æ˜¾ç¤ºå·®å¼‚

### ç¤ºä¾‹ä»£ç 

```clojure
;; è¿è¡Œä¸€ä¸ªç®€å•çš„æµ‹è¯•
(app {:request-method :get
      :uri "/"
      :headers {}})

;; è¿è¡Œå¸¦è®¤è¯çš„æµ‹è¯•
(app {:request-method :get
      :uri "/protected"
      :headers {"authorization" "Bearer secret-token"}})

;; æ¸…ç©º Portal å†å²
(clear-portal!)
```

## ğŸ” ä¸­é—´ä»¶è¯´æ˜

Notebook ä¸­åŒ…å«ä»¥ä¸‹ä¸­é—´ä»¶ç¤ºä¾‹ï¼š

1. **CORS ä¸­é—´ä»¶** - æ·»åŠ è·¨åŸŸèµ„æºå…±äº«å¤´éƒ¨
2. **è¯·æ±‚ ID ä¸­é—´ä»¶** - ä¸ºæ¯ä¸ªè¯·æ±‚æ·»åŠ å”¯ä¸€æ ‡è¯†ç¬¦
3. **è®¡æ—¶ä¸­é—´ä»¶** - æµ‹é‡è¯·æ±‚å¤„ç†æ—¶é—´
4. **èº«ä»½è®¤è¯ä¸­é—´ä»¶** - æ£€æŸ¥æˆæƒä»¤ç‰Œ
5. **JSON å¤„ç†ä¸­é—´ä»¶** - è§£æå’Œæ ¼å¼åŒ– JSON

æ¯ä¸ªä¸­é—´ä»¶éƒ½ä¼šå°†å¤„ç†å‰åçš„æ•°æ®å‘é€åˆ° Portalï¼Œæ–¹ä¾¿å¯¹æ¯”ã€‚

## ğŸ’¡ Portal ä½¿ç”¨æŠ€å·§

### 1. æŸ¥çœ‹ Diff
- é€‰æ‹©ä¸¤ä¸ªæ•°æ®é¡¹ï¼ˆé€šå¸¸æ˜¯åŒä¸€ä¸­é—´ä»¶çš„ before/afterï¼‰
- `Cmd+D` æˆ– `Ctrl+D` æŸ¥çœ‹å·®å¼‚
- ç»¿è‰²è¡¨ç¤ºæ–°å¢ï¼Œçº¢è‰²è¡¨ç¤ºåˆ é™¤

### 2. è¿‡æ»¤æ•°æ®
- ä½¿ç”¨æœç´¢æ¡†è¿‡æ»¤ç‰¹å®šçš„ä¸­é—´ä»¶
- ä¾‹å¦‚ï¼šè¾“å…¥ "CORS" åªæŸ¥çœ‹ CORS ä¸­é—´ä»¶çš„æ•°æ®

### 3. å¯¼èˆªå†å²
- ä½¿ç”¨ä¸Šä¸‹ç®­å¤´é”®åœ¨å†å²è®°å½•ä¸­å¯¼èˆª
- `Cmd+K` æ‰“å¼€å‘½ä»¤é¢æ¿

### 4. æ¸…ç©ºæ•°æ®
```clojure
(clear-portal!)
```

## ğŸ“š ç›¸å…³èµ„æº

- [Portal æ–‡æ¡£](https://github.com/djblue/portal)
- [Ring ä¸­é—´ä»¶æŒ‡å—](https://github.com/ring-clojure/ring/wiki/Concepts#middleware)
- [Clerk æ–‡æ¡£](https://github.com/nextjournal/clerk)

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡è¿™ä¸ª notebookï¼Œä½ å°†å­¦ä¼šï¼š

1. Ring ä¸­é—´ä»¶çš„å·¥ä½œåŸç†
2. ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåºå’Œæ•°æ®æµ
3. å¦‚ä½•ä½¿ç”¨ Portal è°ƒè¯•å’Œå¯è§†åŒ–æ•°æ®
4. å¦‚ä½•ä½¿ç”¨ `tap>` è¿›è¡Œå¼€å‘æ—¶çš„æ•°æ®æ¢æŸ¥
5. ä¸­é—´ä»¶å¯¹è¯·æ±‚å’Œå“åº”çš„å…·ä½“å½±å“

## ğŸ”§ è‡ªå®šä¹‰

ä½ å¯ä»¥è½»æ¾æ·»åŠ è‡ªå·±çš„ä¸­é—´ä»¶ï¼š

```clojure
(defn wrap-my-middleware
  "æˆ‘çš„è‡ªå®šä¹‰ä¸­é—´ä»¶"
  [handler]
  (fn [request]
    ;; å¤„ç†è¯·æ±‚
    (let [modified-request (assoc request :my-key "my-value")]
      ;; å‘é€åˆ° Portal
      (tap-diff "æˆ‘çš„ä¸­é—´ä»¶"
                {:request request}
                {:request modified-request})
      ;; ç»§ç»­å¤„ç†
      (handler modified-request))))
```

## ğŸ› æ•…éšœæ’é™¤

### Portal æ²¡æœ‰æ‰“å¼€
```clojure
(ensure-portal!)
```

### çœ‹ä¸åˆ°æ•°æ®
ç¡®ä¿å·²ç»æ·»åŠ  tapï¼š
```clojure
(add-tap #'p/submit)
```

### æ¸…ç©ºæ‰€æœ‰æ•°æ®
```clojure
(clear-portal!)
```

## ğŸ“ æ³¨æ„äº‹é¡¹

- Portal çª—å£éœ€è¦ä¿æŒæ‰“å¼€æ‰èƒ½çœ‹åˆ°å®æ—¶æ•°æ®
- æ¯æ¬¡è¿è¡Œç¤ºä¾‹éƒ½ä¼šå‘ Portal å‘é€æ–°æ•°æ®
- ä½¿ç”¨ `clear-portal!` æ¸…ç†ä¸éœ€è¦çš„å†å²æ•°æ®
- Portal çš„ diff åŠŸèƒ½å¯¹ç†è§£ä¸­é—´ä»¶çš„å½±å“éå¸¸æœ‰å¸®åŠ©
